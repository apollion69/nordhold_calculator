# Nordhold Realtime Damage Calculator

Date: 2026-02-25
Owner: codex

## TODO
- [x] Set canonical task lock in `TASKS.md` (`T30`, `in_progress`, owner=`codex`).
- [x] Canonicalize project structure and define source-of-truth paths.
- [x] Implement versioned wave-simulation data model with provenance.
- [x] Implement simulation engine modes: `expected`, `combat`, `monte_carlo`.
- [x] Implement local bridge (`/live/*`, replay import/fallback, extract stubs).
- [x] Implement API v1 endpoints for timeline and analytics.
- [x] Add web frontend scaffold (React + TypeScript + worker) and launcher.
- [x] Add unit/simulation/golden/api tests.
- [x] Add runbook/docs for runtime modes and patch signature updates.
- [x] Update `STATUS.md` and `DECISIONS.md` with implementation outcome.

## DONE
- [x] Confirmed source-of-truth target: `codex/projects/nordhold`.
- [x] Confirmed local game install available for bridge work (`Steam appid 3028310`, IL2CPP layout present).
- [x] Added `data/versions` layout with active dataset, changelog and memory signature profile stub.
- [x] Added realtime domain package `src/nordhold/realtime/*`:
  - catalog loader,
  - timeline simulation engine,
  - analytics helpers,
  - live bridge state machine,
  - replay import/store.
- [x] Extended `src/nordhold/api.py` with full `/api/v1/*` surface:
  - live connect/status/snapshot,
  - replay import,
  - timeline evaluate,
  - compare/sensitivity/forecast analytics.
- [x] Added `web/` frontend scaffold (React + TypeScript + worker) for realtime planner and dashboards.
- [x] Added launcher script: `scripts/start_nordhold_realtime.ps1`.
- [x] Hardened launcher to auto-build `web/dist`:
  - uses Windows `npm` when available,
  - falls back to `wsl.exe` build path when Windows `npm` is absent.
- [x] Added test suite and fixtures:
  - `tests/test_realtime_engine.py`,
  - `tests/test_replay_live.py`,
  - `tests/test_golden_regression.py`,
  - `tests/test_api_contract.py`,
  - `runtime/golden/input_wave_eval.json`,
  - `runtime/golden/expected_wave_eval.json`.
- [x] Final verification:
  - backend tests `6/6 OK`,
  - frontend production build `OK`,
  - API smoke passed for all `/api/v1/*` endpoints.

## DONE (T31 Live Memory v1)
- [x] Added profile-driven memory reader module:
  - `src/nordhold/realtime/memory_reader.py`
  - supports `address` and `pointer_chain` field sources,
  - typed reads: `int32`, `uint32`, `float32`, `float64`,
  - profile-level `pointer_size` override (`4|8`).
- [x] Integrated memory reader into `LiveBridge` with safe fallback:
  - memory connect validation on `connect`,
  - degrade on read/connect errors with stable replay/synthetic behavior.
- [x] Extended API live connect payload:
  - optional `signature_profile_id` in `/api/v1/live/connect`.
- [x] Upgraded signature data format:
  - `data/versions/1.0.0/memory_signatures.json` -> `schema_version: live_memory_v1`.
- [x] Added tests:
  - `tests/test_live_memory_v1.py`,
  - extended `tests/test_replay_live.py` for memory snapshot failure fallback.
- [x] Verification:
  - `PYTHONPATH=src python3 -m unittest discover -s tests -v` -> `11 OK` (`1 skipped`),
  - `C:\\Users\\lenovo\\Documents\\cursor\\.venv\\Scripts\\python.exe -m unittest discover -s tests -v` -> `11 OK`.

## DONE (T32/T33 Live Calibration + Integration)
- [x] Ran live memory scan/narrow workflow against running `NordHold.exe`.
- [x] Saved calibration artifacts:
  - `worklogs/t32-live-memory-calibration/artifacts/20260226_live/*`.
- [x] Built calibration candidate overlay:
  - `worklogs/t33-live-integration-validation/artifacts/memory_calibration_candidates_from_t32.json`.
- [x] Verified live bridge connection with calibrated candidate (`artifact_combo_1`):
  - `/api/v1/live/connect` -> `status=connected`, `mode=memory`,
  - `/api/v1/live/snapshot` -> `wave=3`, `gold=99`, `essence=9`, `source_mode=memory`.
- [x] Re-ran test suites:
  - `PYTHONPATH=src python3 -m unittest discover -s tests -v` -> `14 OK` (`1 skipped`),
  - `C:\\Users\\lenovo\\Documents\\cursor\\.venv\\Scripts\\python.exe -m unittest discover -s tests -v` -> `14 OK`.
- [x] Hardened shutdown script:
  - `scripts/stop_nordhold_realtime.ps1` now matches `python.exe` + `python3*.exe` uvicorn workers.
  - validated: `stop` removes listener `127.0.0.1:8000` before restart.

## DONE (T34 Frontend Realtime UX)
- [x] Added 1-second live snapshot polling in frontend for:
  - `GET /api/v1/live/status`,
  - `GET /api/v1/live/snapshot`.
- [x] Added dedicated live cards in wave dashboard:
  - `wave`, `gold`, `essence`, `source_mode`.
- [x] Replaced actions-only flow with interactive timeline actions editor:
  - add/remove/edit rows for `wave`, `at_s`, `type`, `target_id`, `value`, `payload JSON`,
  - kept synchronized raw JSON textarea for power users.
- [x] Added per-wave table with expandable breakdown:
  - columns: `potential`, `combat`, `dps`, `clear`, `leaks`,
  - live wave marker highlights plan-vs-live both in table and in bar chart.
- [x] Updated mobile layout rules in `web/src/styles.css` for new editor/table blocks.
- [x] Build verification:
  - `cd web && npm run build` -> `OK` (`vite build`),
  - artifact: `worklogs/t34-frontend-realtime-ux/artifacts/20260226_1103-web-build.log`.

## DONE (T34 Backend Calibration Automation)
- [x] Added scanner subcommand:
  - `scripts/nordhold_memory_scan.py build-calibration-candidates`
  - input flags:
    - `--current-wave-meta`,
    - `--gold-meta`,
    - `--essence-meta`,
    - `--out`.
- [x] Added calibration helper module:
  - `src/nordhold/realtime/calibration_candidates.py`:
    - snapshot -> candidate generation,
    - candidate summary parsing for API/diagnostics.
- [x] Extended live diagnostics:
  - `src/nordhold/realtime/live_bridge.py` now exposes:
    - `required_field_resolution`,
    - `calibration_candidate_ids`,
    - `last_memory_values`,
    - `last_error`.
- [x] Added calibration inspection endpoint:
  - `GET /api/v1/live/calibration/candidates?path=...`.
- [x] Targeted verification:
  - `PYTHONPATH=src python3 -m unittest -v tests.test_live_memory_v1 tests.test_replay_live` -> `OK`.

## DONE (T35 Engine Regression + Golden Hardening)
- [x] Added deterministic runtime-action combat test:
  - `tests/test_realtime_engine.py`.
- [x] Added monte-carlo determinism/aggregation test:
  - `tests/test_realtime_engine.py`.
- [x] Extended golden regression harness to all fixtures:
  - `tests/test_golden_regression.py` now validates `runtime/golden/input_*.json`.
- [x] Added new golden fixtures:
  - `input_combat_runtime_actions.json` + `expected_combat_runtime_actions.json`,
  - `input_monte_carlo_seeded.json` + `expected_monte_carlo_seeded.json`.
- [x] Added cross-runtime float stabilization for byte-level golden parity:
  - `src/nordhold/realtime/models.py` (`EvaluationResult.to_dict` normalization).
- [x] Full verification:
  - Linux: `PYTHONPATH=src python3 -m unittest discover -s tests -v` -> `17 OK` (`2 skipped`),
  - Windows: `C:\\Users\\lenovo\\Documents\\cursor\\.venv\\Scripts\\python.exe -m unittest discover -s tests -v` -> `17 OK`.

## DONE (T36 Live Connect UX + Auto-Reconnect Prep)
- [x] Added UI-first live connection controls in `web/src/App.tsx`:
  - process/admin/poll controls,
  - optional dataset/profile/replay/calibration fields.
- [x] Added candidate loading flow:
  - `Load Candidates` calls `GET /api/v1/live/calibration/candidates?path=...`,
  - candidate select syncs to `calibration_candidate_id`.
- [x] Added connect action:
  - `Connect Live` posts payload to `POST /api/v1/live/connect`.
- [x] Added bounded auto-reconnect loop:
  - retries connect by interval while live mode is not `memory`.
- [x] Extended frontend type contracts:
  - `LiveConnectRequest`,
  - `LiveCalibrationCandidatesResponse`,
  - `LiveStatus.calibration_candidate_ids`.
- [x] Synced docs/contracts:
  - `tests/test_api_contract.py` includes `/api/v1/live/calibration/candidates`,
  - `README.md` and `RUNBOOK.md` document connect + candidates + auto-reconnect flow.
- [x] Validation:
  - `PYTHONPATH=src python3 -m unittest discover -s tests -v` -> `17 OK` (`2 skipped`),
  - `C:\\Users\\lenovo\\Documents\\cursor\\.venv\\Scripts\\python.exe -m unittest -v tests.test_api_contract` -> `1 OK`,
  - `cd web && npm run build` -> `OK`.
- [x] Artifacts:
  - `worklogs/t36-live-session-prep/artifacts/20260226_111748-python-tests.log`,
  - `worklogs/t36-live-session-prep/artifacts/20260226_111748-web-build.log`,
  - `worklogs/t36-live-session-prep/artifacts/20260226_112055-windows-api-contract.log`.

## DONE (T37 Windows EXE Packaging)
- [x] Added Windows launcher entrypoint:
  - `src/nordhold/launcher.py`.
- [x] Added bundled runtime path resolution in API:
  - `src/nordhold/api.py` now supports:
    - `NORDHOLD_PROJECT_ROOT`,
    - `NORDHOLD_WEB_DIST`,
    - frozen path probing for EXE mode.
- [x] Added EXE build pipeline:
  - `scripts/build_nordhold_realtime_exe.ps1`.
- [x] Updated docs for EXE workflow:
  - `README.md`,
  - `RUNBOOK.md`.
- [x] Built EXE artifact:
  - `runtime/dist/NordholdRealtimeLauncher/NordholdRealtimeLauncher.exe`.
- [x] EXE smoke validation:
  - launched EXE on `127.0.0.1:8012`,
  - verified `/health` -> `{\"status\":\"ok\"}`,
  - terminated process cleanly after check.
- [x] Validation:
  - `PYTHONPATH=src python3 -m unittest discover -s tests -v` -> `17 OK` (`2 skipped`),
  - `C:\\Users\\lenovo\\Documents\\cursor\\.venv\\Scripts\\python.exe -m unittest -v tests.test_api_contract` -> `1 OK`.
- [x] Artifacts:
  - `worklogs/t37-exe-packaging/artifacts/20260226_113013-build-exe-direct.log`,
  - `worklogs/t37-exe-packaging/artifacts/20260226_113040-exe-smoke-verbose.log`,
  - `worklogs/t37-exe-packaging/artifacts/20260226_113040-exe-run.out.log`,
  - `worklogs/t37-exe-packaging/artifacts/20260226_113040-exe-run.err.log`.

## DONE (T56 Memory-First Runtime Hardening, implementation)
- [x] Added snapshot runtime counters and transient-retry flow in `LiveBridge`:
  - `snapshot_failure_streak`,
  - `snapshot_failures_total`,
  - `snapshot_transient_failure_count`,
  - transient detector + one-shot `close -> open -> read_fields` retry path.
- [x] Extended `GET /api/v1/live/status` with additive fields:
  - `snapshot_failure_streak`,
  - `snapshot_failures_total`,
  - `snapshot_transient_failure_count`.
- [x] Updated soak script `scripts/run_nordhold_live_soak.ps1`:
  - default `RequireAdmin=$false`,
  - summary/partial now include:
    - `snapshot_transient_failure_count`,
    - `max_snapshot_failure_streak`,
    - `snapshot_failures_total_last`.
- [x] Kept/verified resolver script behavior in `scripts/resolve_live_memory_candidate.ps1`:
  - default `RequireAdmin=$false`,
  - stable candidate ranking by:
    - min `snapshot_failure_streak_max`,
    - then min `snapshot_failures_total_last`.
- [x] Added/updated tests:
  - transient recovery test in `tests/test_replay_live.py`,
  - non-transient fallback remains `degraded`,
  - status contract extended in `tests/test_api_contract.py` with optional-int compatibility.
- [x] Docs updated:
  - `README.md`,
  - `RUNBOOK.md`.
- [x] Verification artifacts (run `20260228_223411`):
  - tests:
    - `worklogs/t56-memory-soak/20260228_223411/tests_targeted_after_patch.log`,
    - `worklogs/t56-memory-soak/20260228_223411/tests_full_after_patch.log`,
  - smoke soak:
    - `runtime/logs/nordhold-live-soak-20260228_223309.summary.json`,
    - `runtime/logs/nordhold-live-soak-20260228_223309.partial.json`,
    - copied evidence:
      - `worklogs/t56-memory-soak/20260228_223411/nordhold-live-soak-20260228_223309.summary.json`,
      - `worklogs/t56-memory-soak/20260228_223411/nordhold-live-soak-20260228_223309.partial.json`.
- [ ] Acceptance blocker remains:
  - smoke run is completed, but final runtime state is still `mode=degraded`, `reason=memory_unavailable_no_replay` with `ReadProcessMemory ... winerr=299`,
  - 1800s memory-mode PASS requires refreshed stable live candidate against current runtime.

## DONE (T56 Admin Attach + No-Popup Launcher Hardening)
- [x] Updated `scripts/run_nordhold_live_soak.ps1` for popup-safe runtime:
  - added `HideLauncherWindow` (default `true`) so launcher console window does not steal focus,
  - added `AutoElevateForAdmin` (default `true`) for `RequireAdmin=true` attach path,
  - elevated helper includes timeout guard to avoid indefinite wait on elevation flow,
  - added summary/partial fields:
    - `auto_elevate_for_admin`,
    - `launcher_elevated`,
    - `launcher_window_hidden`.
- [x] Updated `scripts/start_nordhold_realtime.ps1`:
  - added `HideBackendWindow` (default `true`) so backend `uvicorn` process starts without popup console window.
- [x] Swarm execution/evidence run: `20260228_224111-swarm`:
  - packet report: `worklogs/t56-memory-soak/20260228_224111-swarm/swarm_report.md`,
  - no-admin smoke: `runtime/logs/nordhold-live-soak-20260228_225347.summary.json`,
  - admin/elevated smoke: `runtime/logs/nordhold-live-soak-20260228_225357.summary.json`,
  - admin + autoconnect smoke: `runtime/logs/nordhold-live-soak-20260228_225411.summary.json`.
- [ ] Acceptance blocker unchanged:
  - admin attach path is now active (`launcher_elevated=true`) and popup-safe (`launcher_window_hidden=true`),
  - runtime still degrades with `memory_unavailable_no_replay` (`ReadProcessMemory ... winerr=299`) until live candidate refresh resolves memory-read instability.

## DONE (T56 Quiet Execution + Runtime Contract Recovery)
- [x] Quiet execution hardening run: `run_id=20260301_050712_t56_quiet`
  - tests:
    - `worklogs/t56-memory-soak/20260301_050712_t56_quiet/tests_targeted.log`
    - `worklogs/t56-memory-soak/20260301_050712_t56_quiet/tests_full.log`
  - build:
    - `scripts/build_nordhold_realtime_exe.ps1` now defaults to quiet hidden external steps (`QuietExternal=$true`) with per-step logs in `runtime/logs`.
    - evidence: `worklogs/t56-memory-soak/20260301_050712_t56_quiet/build_quiet_after_patch.log`
  - soak runtime contract:
    - `scripts/run_nordhold_live_soak.ps1` now recovers `autoconnect` payload from `status.autoconnect_last_result` when POST `/autoconnect` request times out.
    - timeout diagnostics are preserved in additive `autoconnect.request_error`.
    - evidence summary: `runtime/logs/nordhold-live-soak-20260301_051112.summary.json`
    - evidence gate: `worklogs/t56-memory-soak/20260301_050712_t56_quiet/smoke15_after_autoconnect_fallback_patch_gate.json` (`attempts/fallback_used/selected_candidate_id_final` present).
- [ ] Residual blocker (still open):
  - short smoke still ends `last_mode=degraded`, `last_reason=memory_connect_failed:...winerr=299`.
  - current candidate set path remains legacy (`.../nordhold-combat-deep-probe-20260226_154010/...`).
  - diagnostic resolve artifact with fast polling:
    - `worklogs/t56-memory-soak/20260301_050712_t56_quiet/resolve_admin_true.json`
    - result: `best_candidate_id=""` (no stable candidate in current set).
  - next required step remains unchanged: fresh S1/S2/S3 scan-narrow-build candidate refresh, then elevated resolve and 1800s soak.

## DONE (T56 TDD Iteration: Connect Retry + Autoconnect Failover)
- [x] Backend `LiveBridge` connect-path hardening:
  - added status counters:
    - `connect_failures_total`,
    - `connect_transient_failure_count`,
    - `connect_retry_success_total`,
  - added connect-stage transient one-shot retry on `winerr=299` + `ReadProcessMemory failed`,
  - preserved explicit `memory_connect_failed:*` reason (no unconditional overwrite to `memory_unavailable_no_replay`),
  - added deterministic autoconnect candidate failover chain and additive payload fields:
    - `autoconnect_last_result.attempts`,
    - `autoconnect_last_result.selected_candidate_id_final`,
    - `autoconnect_last_result.fallback_used`.
- [x] Script updates:
  - `scripts/run_nordhold_live_soak.ps1` summary/partial now include:
    - `admin_fallback_applied`,
    - `autoconnect_attempt_require_admin`,
  - one-time admin fallback autoconnect is triggered when initial no-admin autoconnect reason is `process_found_but_admin_required`,
  - `scripts/resolve_live_memory_candidate.ps1` ranking now prefers:
    - min `connect_failures_total_last`,
    - then min `snapshot_failure_streak_max`,
    - then min `snapshot_failures_total_last`,
  - resolve output now includes last-error taxonomy fields.
- [x] Windows bootstrap (ops prerequisite):
  - installed Python `3.11.9` (`C:\Users\admin\AppData\Local\Programs\Python\Python311\python.exe`),
  - created project venv `.venv-win311` for scan/probe CLI chain.
- [x] Tests (TDD RED -> GREEN):
  - `PYTHONPATH=src python3 -m unittest -v tests.test_replay_live tests.test_api_contract` -> `OK` (`skipped=7` for missing `fastapi` in env),
  - `PYTHONPATH=src python3 -m unittest discover -s tests -v` -> `OK` (`skipped=7` for missing `fastapi` in env).
- [x] Script validation:
  - PowerShell parse checks passed for:
    - `scripts/run_nordhold_live_soak.ps1`,
    - `scripts/resolve_live_memory_candidate.ps1`.
- [x] Smoke soak evidence:
  - `runtime/logs/nordhold-live-soak-20260228_232640.summary.json`,
  - `runtime/logs/nordhold-live-soak-20260228_232640.partial.json`.
- [ ] Acceptance blocker remains:
  - smoke still ends with `last_mode=degraded`, `last_reason=memory_unavailable_no_replay`,
  - underlying memory read failure persists (`ReadProcessMemory ... winerr=299`) and still requires live candidate refresh + long `1800s` PASS run.
